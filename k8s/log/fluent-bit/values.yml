serviceAccount:
  create: false  # eksctl로 생성한 ServiceAccount 사용
  name: fluent-bit

# 메인 설정
config:
  service: |
    [SERVICE]
        Parsers_File parsers.conf
        # HTTP 서버 활성화 (health check용)
        HTTP_Server  On
        HTTP_Listen  0.0.0.0
        HTTP_Port    2020

  # 로그 수집 설정
  inputs: |
    [INPUT]
        Name              tail
        Tag               kube.*
        Path              /var/log/containers/*.log
        Parser            docker
        DB                /var/log/flb_kube.db
        # 메모리 버퍼 설정 추가
        storage.type      memory
        Mem_Buf_Limit     5MB

  # 쿠버네티스 메타데이터 필터 설정
  filters: |
    [FILTER]
        Name                kubernetes
        Match               kube.*
        Merge_Log          On
        Keep_Log           Off
        K8S-Logging.Parser On
        K8S-Logging.Exclude On

  # CloudWatch 출력 설정
  outputs: |
    [OUTPUT]
        Name                cloudwatch_logs
        Match               *
        region              ap-northeast-2
        log_group_name      /aws/eks/my-cluster1/fluent-bit
        log_stream_prefix   -kube.var.log.containers.
        auto_create_group   true
        # retry 설정 추가
        retry_limit         False

# 리소스 제한 설정
resources:
  limits:
    memory: 128Mi
    cpu: 100m
  requests:
    memory: 128Mi
    cpu: 100m

# Health check 설정
livenessProbe:
  httpGet:
    path: /
    port: 2020
  initialDelaySeconds: 30  # 컨테이너 시작 후 30초 대기
  periodSeconds: 10        # 10초마다 체크
  timeoutSeconds: 5        # 5초 안에 응답이 없으면 실패

readinessProbe:
  httpGet:
    path: /api/v1/health
    port: 2020
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5

# 추가 보안 설정
tolerations:
  - operator: "Exists"

# 볼륨 마운트 설정 (기본값 사용)
volumes:
  - name: varlog
    hostPath:
      path: /var/log
  - name: varlibdockercontainers
    hostPath:
      path: /var/lib/docker/containers

volumeMounts:
  - name: varlog
    mountPath: /var/log
  - name: varlibdockercontainers
    mountPath: /var/lib/docker/containers
    readOnly: true